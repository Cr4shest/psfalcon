class Falcon {
    [string] $Hostname
    [string] $ClientId
    [string] $ClientSecret
    [string] $MemberCid
    [string] $Token
    [datetime] $Expires
    [hashtable] $Endpoints
    [hashtable] $ItemTypes
    [hashtable] $Parameters
    [hashtable] $Patterns
    [hashtable] $Schema
    [System.Globalization.TextInfo] $Culture
    Falcon ($Data) {
        # Ingest input data generated by Falcon.psm1 and determine culture for dynamic parameter naming
        $this.Culture = (Get-Culture).TextInfo
        $this.Endpoints = $Data.Endpoints
        $this.ItemTypes = $Data.ItemTypes
        $this.Parameters = $Data.Parameters
        $this.Patterns = $Data.Patterns
        $this.Schema = $Data.Schema
        $this.PSObject.TypeNames.Insert(0,'Falcon')
    }
    [hashtable] GetEndpoint([string] $Endpoint) {
        $Path = $Endpoint.Split(':')[0]
        $Method = $Endpoint.Split(':')[1]
        if (-not($Path -and $Method)) {
            throw "Invalid endpoint: '$Endpoint'"
        }
        # Gather endpoint properties and begin output construction
        $Ref = ($this.Endpoints.$Path.$Method).Clone()
        $Output = @{
            path = $Path
            method = $Method
        }
        if ($Ref.parameters) {
            $Output['parameters'] = if ($Ref.parameters.schema) {
                # Build from Schema
                $this.GetSchema($Ref.parameters.schema)
            }
            elseif ($Ref.parameters) {
                $Shared = @{}
                $Ref.parameters.Keys.Where({ $this.Parameters.$_ }).foreach{
                    # Build from shared Parameters
                    $Shared[$_] = $this.Parameters.($_)
                }
                $Shared
            }
            ($Output.parameters).GetEnumerator().foreach{
                foreach ($Pair in ($Output.parameters).GetEnumerator()) {
                    if ($Ref.parameters.($Pair.Key)) {
                        ($Ref.parameters.($Pair.Key)).GetEnumerator().foreach{
                            # Force manual parameter properties from endpoint
                            $Output.parameters.($Pair.Key)[$_.Key] = $_.Value
                        }
                    }
                }
                if (-not $_.Value.dynamic) {
                    # Generate dynamic parameter name
                    $_.Value['dynamic'] = $this.Culture.ToTitleCase($_.Key) -replace '[^a-zA-Z0-9]',''
                }
                if (($_.Key -match '^(id|ids)$') -and (-not $_.Value.pattern)) {
                    # Append default RegEx pattern by endpoint
                    $_.Value['pattern'] = $this.GetPattern($Endpoint)
                }
                # Update description with ItemType
                $_.Value['description'] = $this.GetItemType($Endpoint, $_.Value.description)
                # Add ParameterSetName
                $_.Value['set'] = $Endpoint
            }
        }
        $Ref.GetEnumerator().Where({ $_.Key -ne 'parameters' }).foreach{
            if ($_.Key -eq 'description') {
                # Update description using ItemType
                $Output[$_.Key] = $this.GetItemType($Endpoint, $_.Value)
            }
            else {
                # Add directly to output
                $Output[$_.Key] = $_.Value
            }
        }
        return $Output
    }
    [string] GetItemType([string] $Endpoint, [string] $Value) {
        $Output = if ($Value -match '\{0\}') {
            $ItemType = $this.ItemTypes.GetEnumerator().Where({ $Endpoint -match $_.Key }).Value
            $Value -f $ItemType
        }
        else {
            $Value
        }
        return $Output
    }
    [string] GetPattern([string] $Endpoint) {
        # Match Endpoint to Patterns
        return $this.Patterns.GetEnumerator().Where({ $Endpoint -match $_.Key }).Value
    }
    [string] GetResponse([string] $Endpoint, [int] $Code) {
        # Gather Endpoint.Responses and output response type
        $Path = $Endpoint.Split(':')[0]
        $Method = $Endpoint.Split(':')[1]
        if (-not($Path -and $Method)) {
            throw "Invalid endpoint: '$Endpoint'"
        }
        $Responses = $this.Endpoints.$Path.$Method.responses
        $Output = $Responses.GetEnumerator().Where({ $_.Value -contains $Code }).Key
        if ($Output) {
            return $Output
        }
        else {
            return $Responses.default
        }
    }
    [hashtable] GetSchema([string] $Schema) {
        # Gather schema and output all references as a single parameter set
        $Output = @{}
        $this.Schema.($Schema).GetEnumerator().foreach{
            if ($_.Value.schema) {
                $Parent = $_.Key
                $this.GetSchema($_.Value.schema).GetEnumerator().foreach{
                    $Output[$_.Key] = $_.Value
                    $Output.($_.Key)['parent'] = $Parent
                }
            }
            else {
                $Output[$_.Key] = $_.Value
            }
        }
        return $Output
    }
    [string] Rfc3339($Int) {
        # Convert number of hours into an RFC-3339 string
        return "$([Xml.XmlConvert]::ToString((Get-Date).AddHours($Int),[Xml.XmlDateTimeSerializationMode]::Utc))"
    }
}